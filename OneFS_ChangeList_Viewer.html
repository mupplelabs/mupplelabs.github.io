<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OneFS ChangeList Viewer</title>
<style>
  /* global styles */
  :root {
    --bg: #0f172a;
    --panel: #111827;
    --panel-2: #0b1220;
    --text: #e5e7eb;
    --muted: #94a3b8;
    --border: #1f2937;
    --accent: #38bdf8;
    --accent-2: #22d3ee;
  }

  /* light theme */
  .theme-light {
    --bg: #f8fafc;
    --panel: #ffffff;
    --panel-2: #f1f5f9;
    --text: #0f172a;
    --muted: #64748b;
    --border: #e2e8f0;
    --accent: #0284c7;
    --accent-2: #0891b2;
  }

  /* shell styles */
  html, body {
    height: 100%;
  }

  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Ubuntu, Cantarell, "Noto Sans", Helvetica Neue, Arial;
  }

  header {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    background: var(--panel);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  footer {
    padding: 10px 14px;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    background: var(--panel);
    position: sticky;
    bottom: 0;
    z-index: 10;
  }

  .shell {
    display: grid;
    grid-template-columns: 280px 6px 1fr 6px 360px;
    height: calc(100vh - 100px);
  }

  .panel {
    background: var(--panel);
    overflow: auto;
  }

  .splitter {
    background: var(--panel-2);
    cursor: col-resize;
  }

  /* tree styles */
  #tree {
    padding: 10px;
  }

  .tree-title {
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .tree-search {
    width: 92%;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--panel-2);
    color: var(--text);
  }

  .tree {
    list-style: none;
    padding-left: 0;
    margin-top: 8px;
  }

  .node {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 6px;
    border-radius: 6px;
    cursor: pointer;
  }

  .node:hover {
    background: var(--panel-2);
  }

  .node.active {
    outline: 1px solid var(--accent);
  }

  .toggle {
    width: 16px;
    text-align: center;
    color: var(--muted);
  }

  .label {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .count {
    font-size: 11px;
    color: var(--muted);
  }

  .children {
    margin-left: 14px;
    border-left: 1px dashed var(--border);
    padding-left: 8px;
  }

  /* controls styles */
  #controls {
    padding: 10px;
    border-bottom: 1px solid var(--border);
  }

  .row {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .button {
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--panel-2);
    color: var(--text);
    cursor: pointer;
  }

  .button:hover {
    filter: brightness(1.1);
  }

  .control {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .control input,
  .control select {
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--panel-2);
    color: var(--text);
  }

  .muted {
    color: var(--muted);
    font-size: 12px;
  }

  .dropdown {
    position: relative;
  }

  .dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px;
    min-width: 260px;
    display: none;
    z-index: 20;
  }

  .dropdown-menu.show {
    display: block;
  }

  .opt {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 6px;
    border-radius: 6px;
  }

  .opt:hover {
    background: var(--panel-2);
  }

  .section {
    padding: 4px 6px;
    color: var(--muted);
    font-size: 12px;
  }

  #viewport {
    position: relative;
    height: calc(100% - 220px);
    overflow: auto;
    background: var(--panel);
    border-top: 1px solid var(--border);
  }

  .vtable {
    position: relative;
  }

  .row-item {
    position: absolute;
    left: 0;
    right: 0;
    height: var(--row-height, 36px);
    display: grid;
    align-items: center;
    border-bottom: 1px solid var(--border);
    padding: 0 8px;
  }

  .row-item:hover {
    background: var(--panel-2);
  }

  .cell {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .header {
    position: sticky;
    top: 0;
    z-index: 5;
    display: grid;
    align-items: center;
    padding: 6px 8px;
    background: var(--panel);
    border-bottom: 1px solid var(--border);
  }

  .th {
    font-weight: 600;
    position: relative;
  }

  .col-resize {
    position: absolute;
    right: 0;
    top: 0;
    width: 6px;
    height: 100%;
    cursor: col-resize;
  }

  /* pills color variables */
  :root {
    --pill-added-bg: #14532d;
    --pill-added-fg: #86efac;
    --pill-removed-bg: #7f1d1d;
    --pill-removed-fg: #fecaca;
    --pill-modified-bg: #7c2d12;
    --pill-modified-fg: #fde68a;
    --pill-path-bg: #1e3a8a;
    --pill-path-fg: #bfdbfe;
    --pill-ads-bg: #4c1d95;
    --pill-ads-fg: #ddd6fe;
    --pill-hardlinks-bg: #0c4a6e;
    --pill-hardlinks-fg: #bae6fd;
    --pill-parent-bg: #334155;
    --pill-parent-fg: #cbd5e1;
    --pill-lookup-bg: #075985;
    --pill-lookup-fg: #a5f3fc;
    --pill-worm-bg: #065f46;
    --pill-worm-fg: #a7f3d0;
  }

  .theme-light {
    --pill-added-bg: #dcfce7;
    --pill-added-fg: #14532d;
    --pill-removed-bg: #fee2e2;
    --pill-removed-fg: #7f1d1d;
    --pill-modified-bg: #ffedd5;
    --pill-modified-fg: #7c2d12;
    --pill-path-bg: #dbeafe;
    --pill-path-fg: #1e3a8a;
    --pill-ads-bg: #ede9fe;
    --pill-ads-fg: #4c1d95;
    --pill-hardlinks-bg: #e0f2fe;
    --pill-hardlinks-fg: #0c4a6e;
    --pill-parent-bg: #e2e8f0;
    --pill-parent-fg: #334155;
    --pill-lookup-bg: #cffafe;
    --pill-lookup-fg: #075985;
    --pill-worm-bg: #d1fae5;
    --pill-worm-fg: #065f46;
  }

  .pill {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 999px;
    font-size: 12px;
    margin-right: 6px;
    border: 1px solid var(--border);
  }
  .pill.added{
      background:var(--pill-added-bg);
      color:var(--pill-added-fg)
  } 
  .pill.removed{
      background:var(--pill-removed-bg);
      color:var(--pill-removed-fg)
  } 
  .pill.modified{
      background:var(--pill-modified-bg);
      color:var(--pill-modified-fg)
  }.pill.path{
      background:var(--pill-path-bg);
      color:var(--pill-path-fg)
  } 
  .pill.ads{
      background:var(--pill-ads-bg);
      color:var(--pill-ads-fg)
  } 
  .pill.hardlinks{
      background:var(--pill-hardlinks-bg);
      color:var(--pill-hardlinks-fg)
  }
  .pill.parent{
      background:var(--pill-parent-bg);
      color:var(--pill-parent-fg)
  } 
  .pill.lookup{
      background:var(--pill-lookup-bg);
      color:var(--pill-lookup-fg)
  } 
  .pill.worm{
      background:var(--pill-worm-bg);
      color:var(--pill-worm-fg)
  }

</style>
</head>
<body>
<header>
  <div>
    <div style="font-weight:600;">OneFS ChangeList Viewer</div>
    <div class="muted">Explore ChangeLists in Style</div>
  </div>
  <div id="message"></div>
  <div class="row">
    <button id="reset-btn" class="button">Reset</button>
    <label for="file-input" class="button">Load JSON</label>
    <input id="file-input" type="file" accept="application/json" style="display:none;" />
    <button id="demo-btn" class="button">Reload Demo</button>
    <button id="theme-toggle" class="button">Light/Dark</button>
  </div>
</header>
<div class="shell" id="shell">
  <aside id="tree" class="panel">
    <div class="tree-title">
      <span>Directories</span>
      <span class="row">
        <button id="expand-all" class="button">Expand</button>
        <button id="collapse-all" class="button">Collapse</button>
      </span>
    </div>
    <input id="tree-search" class="tree-search" type="text" placeholder="Search directories..." />
    <ul id="tree-root" class="tree"></ul>
  </aside>
  <div id="split-left" class="splitter" title="Drag to resize"></div>

  <main id="center" class="panel">
    <section id="controls">
      <div class="row" style="justify-content: space-between;">
        <div class="row">
          <div class="control"><label>Path contains<input id="f-path" type="text" placeholder="e.g. /foo" /></label></div>
          <div class="control"><label>Filename contains<input id="f-name" type="text" placeholder="e.g. .bin" /></label></div>
          <div class="control"><label>File type<select id="f-type"><option value="">(any)</option><option value="regular">regular</option><option value="directory">directory</option><option value="(REMOVED)">(REMOVED)</option></select></label></div>
          <div class="control"><label>CTime start<input id="f-start" type="datetime-local" /></label></div>
          <div class="control"><label>CTime end<input id="f-end" type="datetime-local" /></label></div>
        </div>
        <div class="row">
          <!-- Change type selector -->
          <div class="dropdown">
            <button id="change-types-btn" class="button">Change types ▾</button>
            <div id="change-types-menu" class="dropdown-menu">
              <label class="opt"><input type="checkbox" name="ct" value="ENTRY_MODIFIED"> <span class="pill modified">ENTRY_MODIFIED</span></label>
              <label class="opt"><input type="checkbox" name="ct" value="ENTRY_ADDED"> <span class="pill added">ENTRY_ADDED</span></label>
              <label class="opt"><input type="checkbox" name="ct" value="ENTRY_REMOVED"> <span class="pill removed">ENTRY_REMOVED</span></label>
              <label class="opt"><input type="checkbox" name="ct" value="ENTRY_PATH_CHANGED"> <span class="pill path">ENTRY_PATH_CHANGED</span></label>
              <label class="opt"><input type="checkbox" name="ct" value="ENTRY_HAS_ADS"> <span class="pill ads">ENTRY_HAS_ADS</span></label>
              <label class="opt"><input type="checkbox" name="ct" value="ENTRY_ADS"> <span class="pill ads">ENTRY_ADS</span></label>
              <label class="opt"><input type="checkbox" name="ct" value="ENTRY_HAS_HARDLINKS"> <span class="pill hardlinks">ENTRY_HAS_HARDLINKS</span></label>
              <label class="opt"><input type="checkbox" name="ct" value="ENTRY_PARENT_REMOVED"> <span class="pill parent">ENTRY_PARENT_REMOVED</span></label>
              <label class="opt"><input type="checkbox" name="ct" value="ENTRY_PATH_LOOKUP_REQ"> <span class="pill lookup">ENTRY_PATH_LOOKUP_REQ</span></label>
              <label class="opt"><input type="checkbox" name="ct" value="ENTRY_WORM_COMMITTED"> <span class="pill worm">ENTRY_WORM_COMMITTED</span></label>
              <button id="reset-types-menu" class="button">Show all</button>
            </div>
          </div>
          <!-- Column selector -->
          <div class="dropdown">
            <button id="columns-btn" class="button">Columns ▾</button>
            <div id="columns-menu" class="dropdown-menu">
              <div class="section">Display columns</div>
              <div id="columns-list"></div>
              <div class="section">Presets</div>
              <div class="row"><button id="preset-min" class="button">Minimal</button><button id="preset-ext" class="button">Extended</button><button id="preset-all" class="button">All</button></div>
            </div>
          </div>
          <label class="row" style="gap:4px; align-items:center;"><span class="muted">Group by LIN</span><input id="group-by-lin" type="checkbox" /></label>
        </div>
      </div>
      <div class="row" style="margin-top:8px; justify-content: space-between;">
        <div class="row">
          <label class="muted">Sort
          <select id="sort-field"><option value="path">Path</option><option value="file_type">File Type</option><option value="ctime.sec">CTime</option><option value="mtime.sec">MTime</option><option value="size">Size</option><option value="physical_size">Physical Size</option><option value="LIN">LIN</option></select>
          <select id="sort-dir"><option value="desc">Desc</option><option value="asc">Asc</option></select>
          </label>
          <label class="row" style="gap:6px;"><span class="muted">Row height</span><input id="row-height" type="range" min="24" max="60" value="36" /></label>
        </div>
        <div class="row">
          <button id="export-json" class="button">Export JSON</button>
          <button id="export-csv" class="button">Export CSV</button>
          <span class="muted" id="stats">No data</span>
        </div>
      </div>
    </section>

    <section id="timeline" class="row" style="gap:16px; flex-wrap:wrap;"><div class="muted">Timeline per LIN (grouped view)</div></section>
    <section id="viewport"><div id="header" class="header"></div><div id="vtable" class="vtable"></div></section>
  </main>

  <div id="split-right" class="splitter" title="Drag to resize"></div>
  <aside id="details" class="panel">
    <div class="row" style="justify-content: space-between;"><div style="font-weight:600;">Details</div><button id="copy-json" class="button">Copy JSON</button></div>
    <div id="details-summary" class="muted" style="margin-top:6px;">Select a row to view details</div>
    <pre id="details-json"></pre>
  </aside>
</div>
<footer>
  <div class="muted">Version 1.0.0 </div>
  <div class="muted"><a href="https://www.mupplelabs.de">Mupples Innovation Labs</a> - <a href="https://github.com/mupplelabs/OneFS_ChangeList_Viewer">Source</a></div> 
  <div class="muted">#Iwork@DELL</div>
</footer>
<script>
  const sampleChangeList = { entries: [
    {atime:{nsec:0,sec:1761780626}, btime:{nsec:0,sec:1761780626}, change_types:["ENTRY_ADDED","ENTRY_PATH_CHANGED"], ctime:{nsec:0,sec:1761780694}, data_pool:-3, file_type:"regular", gid:0, id:"68794975888", lin:4299685993, metadata_pool:-3, mtime:{nsec:0,sec:1761780626}, parent_lin:4299817158, path:"/foo/file_3.bin", physical_size:16896, size:9516, uid:0, user_flags:["inherit","writecache","wcinherit"]},
    {atime:{nsec:0,sec:1761780694}, btime:{nsec:0,sec:1761780667}, change_types:["ENTRY_ADDED"], ctime:{nsec:0,sec:1761780694}, data_pool:-3, file_type:"directory", gid:0, id:"68797074528", lin:4299817158, metadata_pool:-3, mtime:{nsec:0,sec:1761780694}, parent_lin:4299948664, path:"/foo", physical_size:2048, size:49, uid:0, user_flags:["inherit","writecache","wcinherit"]},
    {atime:{nsec:0,sec:1761780683}, btime:{nsec:0,sec:1761780022}, change_types:["ENTRY_MODIFIED"], ctime:{nsec:0,sec:1761780683}, data_pool:-3, file_type:"directory", gid:0, id:"68799178624", lin:4299948664, metadata_pool:-3, mtime:{nsec:0,sec:1761780683}, parent_lin:2, path:"", physical_size:2048, size:21, uid:0, user_flags:["inherit","writecache","wcinherit"]},
    {atime:{nsec:0,sec:1761780694}, btime:{nsec:0,sec:1761780611}, change_types:["ENTRY_ADDED","ENTRY_PATH_CHANGED"], ctime:{nsec:0,sec:1761780694}, data_pool:-3, file_type:"directory", gid:0, id:"68800240832", lin:4300015052, metadata_pool:-3, mtime:{nsec:0,sec:1761780694}, parent_lin:4299817158, path:"/foo/foo", physical_size:2048, size:56, uid:0, user_flags:["inherit","writecache","wcinherit"]},
    {atime:{nsec:0,sec:1761780626}, btime:{nsec:0,sec:1761780626}, change_types:["ENTRY_REMOVED","ENTRY_PATH_CHANGED"], ctime:{nsec:0,sec:1761780626}, data_pool:-3, file_type:"(REMOVED)", gid:0, id:"2305843078008669840", lin:4299685993, metadata_pool:-3, mtime:{nsec:0,sec:1761780626}, parent_lin:4300015052, path:"/foo/file_3.bin", physical_size:512, size:9516, uid:0, user_flags:["inherit","writecache","wcinherit"]},
    {atime:{nsec:0,sec:1761780626}, btime:{nsec:0,sec:1761780611}, change_types:["ENTRY_REMOVED","ENTRY_PATH_CHANGED"], ctime:{nsec:0,sec:1761780626}, data_pool:-3, file_type:"(REMOVED)", gid:0, id:"2305843078013934784", lin:4300015052, metadata_pool:-3, mtime:{nsec:0,sec:1761780626}, parent_lin:4299948664, path:"/foo", physical_size:2048, size:84, uid:0, user_flags:["inherit","writecache","wcinherit"]}
  ] };

  let DemoMode = true;
  let allEntries = sampleChangeList.entries.slice();
  let filtered = allEntries.slice();
  let grouped = []; let groupByLin=false; let selectedDir='/'; let sortField='ctime.sec'; let sortDir='desc'; let rowHeight=36; let expansion=new Map();

  const columns = [
    { key:'path', label:'Path', width:220, visible:true },
    { key:'file_type', label:'Type', width:100, visible:true },
    { key:'change_types', label:'Change Types', width:260, visible:true },
    { key:'size', label:'Size', width:80, visible:false },
    { key:'physical_size', label:'Physical Size', width:120, visible:false },
    { key:'ctime', label:'CTime', width:160, visible:true },
    { key:'mtime', label:'MTime', width:160, visible:false },
    { key:'path_delta', label:'Path Δ', width:240, visible:true },
    { key:'timeline', label:'Timeline', width:160, visible:true },
    { key:'lin', label:'LIN', width:120, visible:true },
    { key:'uid', label:'UID', width:90, visible:false },
    { key:'gid', label:'GID', width:90, visible:false },
    { key:'parent_lin', label:'Parent LIN', width:120, visible:false },
    { key:'id', label:'ID', width:160, visible:false },
    { key:'user_flags', label:'User Flags', width:200, visible:false },
    { key:'data_pool', label:'Data Pool', width:120, visible:false },
    { key:'metadata_pool', label:'Metadata Pool', width:140, visible:false },
    { key:'atime', label:'ATime', width:160, visible:false },
    { key:'btime', label:'BTime', width:160, visible:false },
  ];

  const el = {
    themeToggle:document.getElementById('theme-toggle'), 
    reloadDemoBtn:document.getElementById('demo-btn'),
    resetBtn:document.getElementById('reset-btn'),
    fPath:document.getElementById('f-path'), 
    fName:document.getElementById('f-name'), 
    fType:document.getElementById('f-type'), 
    fStart:document.getElementById('f-start'), 
    fEnd:document.getElementById('f-end'),
    sortField:document.getElementById('sort-field'), 
    sortDir:document.getElementById('sort-dir'), 
    rowHeight:document.getElementById('row-height'), 
    stats:document.getElementById('stats'),
    changeTypesBtn:document.getElementById('change-types-btn'), 
    changeTypesMenu:document.getElementById('change-types-menu'),
    resetTypesMenu:document.getElementById('reset-types-menu'),
    columnsBtn:document.getElementById('columns-btn'), 
    columnsMenu:document.getElementById('columns-menu'), 
    columnsList:document.getElementById('columns-list'),
    groupByLin:document.getElementById('group-by-lin'), 
    treeRoot:document.getElementById('tree-root'), 
    treeSearch:document.getElementById('tree-search'), 
    expandAll:document.getElementById('expand-all'), 
    collapseAll:document.getElementById('collapse-all'),
    header:document.getElementById('header'), 
    viewport:document.getElementById('viewport'), 
    vtable:document.getElementById('vtable'), 
    timeline:document.getElementById('timeline'),
    splitLeft:document.getElementById('split-left'), 
    splitRight:document.getElementById('split-right'), 
    shell:document.getElementById('shell'),
    detailsSummary:document.getElementById('details-summary'), 
    detailsJson:document.getElementById('details-json'), 
    copyJson:document.getElementById('copy-json'),
    importJson:document.getElementById('file-input'),
    exportJson:document.getElementById('export-json'), 
    exportCsv:document.getElementById('export-csv'),
    presetMin:document.getElementById('preset-min'), 
    presetExt:document.getElementById('preset-ext'), 
    presetAll:document.getElementById('preset-all'),
    messageDisplay:document.getElementById("message")
  };

  // Displays a message to the user
  function showMessage(message, type) {
    if (!message) return;
    el.messageDisplay.textContent = message;
    if (type !== "info") {
      el.messageDisplay.style.color = type === "error" ? "red" : "green";
    } else {
      el.messageDisplay.style.cssText = "text";
    }
  }

  function fmtDate(sec){ if(sec==null) return ''; try{ return new Date(sec*1000).toLocaleString(); }catch{ return String(sec);} }
  function get(obj,path){ return path.split('.').reduce((a,k)=>a&&a[k], obj); }
  function compare(a,b){ const va=get(a,sortField), vb=get(b,sortField), dir=sortDir==='asc'?1:-1; if(va==null&&vb==null) return 0; if(va==null) return -1*dir; if(vb==null) return 1*dir; if(va<vb) return -1*dir; if(va>vb) return 1*dir; return 0; }
  function filename(p){ if(!p) return ''; const i=p.lastIndexOf('/'); return i>=0? p.slice(i+1):p; }
  function pill(t){ let cls='path'; if(t==='ENTRY_ADDED')cls='added'; else if(t==='ENTRY_REMOVED')cls='removed'; else if(t==='ENTRY_MODIFIED')cls='modified'; else if(t==='ENTRY_PATH_CHANGED')cls='path'; else if(t==='ENTRY_HAS_ADS'||t==='ENTRY_ADS')cls='ads'; else if(t==='ENTRY_HAS_HARDLINKS')cls='hardlinks'; else if(t==='ENTRY_PARENT_REMOVED')cls='parent'; else if(t==='ENTRY_PATH_LOOKUP_REQ')cls='lookup'; else if(t==='ENTRY_WORM_COMMITTED')cls='worm'; return `<span class="pill ${cls}">${t}</span>`; }

  const linIndex=new Map();
  function rebuildLinIndex(list){ linIndex.clear(); const map=new Map(); list.forEach(e=>{ const k=e.lin; if(k==null) return; const arr=map.get(k)||[]; arr.push(e); map.set(k,arr); }); for(const [k,arr] of map){ arr.sort((a,b)=> (a?.ctime?.sec||0)-(b?.ctime?.sec||0)); linIndex.set(k,arr); } }
  /**
   * Compute a path delta string for a given entry.
   * For group entries, compute 'prev → latest' if changed; for raw row, attempt previous in LIN
   * @param {Object} entry - The entry to compute the path delta for
   * @returns {String} - The path delta string
   */
  function pathDelta(entry){
    if(entry.__group){
      const evs = entry.events || [];
      const paths = evs.map(e => e.path || '').filter(Boolean);
      const uniq = [];
      for(const p of paths){
        if(uniq.length === 0 || uniq[uniq.length - 1] !== p) uniq.push(p);
      }
      if(uniq.length >= 2) return `${uniq[uniq.length - 2]} → ${uniq[uniq.length - 1]}`;
      return '';
    } else {
      const lin = entry.lin;
      if(lin == null) return '';
      const arr = linIndex.get(lin) || [];
      const idx = arr.findIndex(e => e === entry);
      if(idx > 0){
        const prev = arr[idx - 1];
        const pPrev = prev.path || '';
        const pCurr = entry.path || '';
        if(pPrev && pCurr && pPrev !== pCurr) return `${pPrev} → ${pCurr}`;
      }
      return '';
    }
  }

  /**
   * Generate a sparkline svg given a list of timestamps
   * @param {Array<number>} times - The list of timestamps
   * @returns {String} - The sparkline svg
   */
  function sparkline(times){
    if(!times || times.length === 0) return '';
    const min = Math.min(...times);
    const max = Math.max(...times);
    const w = 140;
    const h = 28;
    const pad = 2;
    const xs = times.map(t => pad + (w - 2 * pad) * ((t - min) / (max - min || 1)));
    const pts = xs.map(x => `${Math.round(x)},${Math.round(h / 2)}`).join(' ');
    return `<svg class="spark" viewBox="0 0 ${w} ${h}"><polyline points="${pts}" fill="none" stroke="${getComputedStyle(document.body).getPropertyValue('--accent').trim()}" stroke-width="2"/></svg>`;
  }
  function selectedChangeTypes(){ return Array.from(el.changeTypesMenu.querySelectorAll('input[name=ct]:checked')).map(i=>i.value); }
  
  /**
   * Applies filters to the entries list
   * @description
   * Filters all entries using the following criteria:
   *   - Directory selection: include root or specific path prefix
   *   - Path substring: include only entries with paths containing the provided substring
   *   - Name substring: include only entries with names containing the provided substring
   *   - File type: include only entries with the provided file type
   *   - Timestamp range: include only entries with timestamps within the provided range
   *   - Change types: include only entries with any of the provided change types
   * @returns {Array} - The filtered entries list
   */
  function applyFilters(){ 
    const pathSub=el.fPath.value.trim(); 
    const nameSub=el.fName.value.trim(); 
    const ft=el.fType.value; const start=el.fStart.value? new Date(el.fStart.value).getTime()/1000:null; 
    const end=el.fEnd.value? new Date(el.fEnd.value).getTime()/1000:null; 
    const typesSel=new Set(selectedChangeTypes());
    filtered = allEntries.filter(e=>{ const p=e.path||'/'; 
    if(selectedDir!=='/' && !p.startsWith(selectedDir)) return false; 
    if(pathSub && !p.toLowerCase().includes(pathSub.toLowerCase())) return false; const fn=filename(p); 
    if(nameSub && !fn.toLowerCase().includes(nameSub.toLowerCase())) return false; 
    if(ft && e.file_type!==ft) return false; const csec=e?.ctime?.sec; 
    if(start && (csec==null||csec<start)) return false; if(end && (csec==null||csec>end)) return false; 
    if(typesSel.size>0){ 
      const set=new Set(e.change_types||[]); 
      let ok=false; 
      for(const t of typesSel){ 
        if(set.has(t)){ ok=true; break; } } if(!ok) return false; } return true; }).sort(compare);
    rebuildLinIndex(filtered);
    if(groupByLin){ const map=new Map(); 
      filtered.forEach(e=>{ const key=e.lin??e.id??Math.random(); 
        const arr=map.get(key)||[]; arr.push(e); map.set(key,arr); }); 
        grouped = Array.from(map.entries()).map(([key,events])=>{ const sorted=events.slice().sort((a,b)=> (a?.ctime?.sec||0)-(b?.ctime?.sec||0)); 
          const first=sorted[0], last=sorted[sorted.length-1]; const union=Array.from(new Set(sorted.flatMap(ev=> ev.change_types||[]))); 
          return { __group:true, lin:first.lin, id:first.id, file_type:last.file_type||first.file_type||'', latest_path:last.path||first.path||'', first_ctime:first?.ctime?.sec, last_ctime:last?.ctime?.sec, change_types:union, events:sorted }; }).sort(compareGroup); }
    renderStats(); renderHeader(); renderTimelineCards(); renderVirtualRows(); renderTree(); }

  function compareGroup(a,b){ 
    const field=sortField, 
    dir=sortDir==='asc'?1:-1; 
    let va,vb; 
    if(field==='ctime.sec'||field==='mtime.sec'){ 
      va=a.last_ctime; vb=b.last_ctime; 
    } else { 
      va=a[field]??get(a,field); vb=b[field]??get(b,field); 
    } 
    if(va==null&&vb==null) return 0; if(va==null) return -1*dir; 
    if(vb==null) return 1*dir; 
    if(va<vb) return -1*dir; 
    if(va>vb) return 1*dir; 
    return 0; 
  }
  function renderStats(){ el.stats.textContent = `${allEntries.length} entries · ${filtered.length} after filters`; }
  function visibleColumns(){ return columns.filter(c=> c.visible); }
  function gridTemplate(){ return visibleColumns().map(c=> `${c.width}px`).join(' '); }
  function renderHeader(){ 
    el.header.innerHTML=''; 
    el.header.style.gridTemplateColumns=gridTemplate(); 
    visibleColumns().forEach(c=>{ 
      const d=document.createElement('div'); d.className='th cell'; 
      d.textContent=c.label; 
      const handle=document.createElement('div'); 
      handle.className='col-resize'; 
      let startX=0,startW=0; 
      handle.addEventListener('mousedown',ev=>{ 
        ev.preventDefault(); 
        startX=ev.clientX; startW=c.width; 
        const mm=e=>{ 
          const dx=e.clientX-startX; 
          c.width=Math.max(50,startW+dx); 
          el.header.style.gridTemplateColumns=gridTemplate(); 
          renderVirtualRows(); 
        }; 
        const mu=()=>{
          document.removeEventListener('mousemove',mm); 
          document.removeEventListener('mouseup',mu); 
        }; 
        document.addEventListener('mousemove',mm); 
        document.addEventListener('mouseup',mu); 
      }); 
        d.appendChild(handle); el.header.appendChild(d); 
    }); 
  }

  function rowsData(){ return groupByLin? grouped: filtered; }
  function renderVirtualRows(){ 
    const data=rowsData(); 
    const vp=el.viewport; 
    const table=el.vtable; 
    table.innerHTML=''; 
    const total=data.length; 
    const height=total*rowHeight; 
    table.style.height=height+'px'; 
    table.style.setProperty('--row-height',
    rowHeight+'px'); 
    table.style.gridTemplateColumns=gridTemplate(); 
    const viewH=vp.clientHeight; 
    const scrollTop=vp.scrollTop; 
    const start=Math.max(0,Math.floor(scrollTop/rowHeight)-2); 
    const visibleCount=Math.ceil(viewH/rowHeight)+4; 
    const end=Math.min(total,start+visibleCount); 
    const frag=document.createDocumentFragment(); 
    for(let i=start;i<end;i++){ 
      const item=data[i]; 
      const row=document.createElement('div'); 
      row.className='row-item'; row.style.top=(i*rowHeight)+'px'; 
      row.style.gridTemplateColumns=gridTemplate(); 
      row.innerHTML=renderRowCells(item); 
      row.addEventListener('click',()=> showDetails(item)); 
      if(item.__group){ 
        row.title='Double-click to expand group events'; 
        row.addEventListener('dblclick',()=> showGroupEvents(item)); 
      } 
      frag.appendChild(row); 
    } 
    table.appendChild(frag); 
  }

  function renderRowCells(entry){ const cells=[]; for(const c of visibleColumns()){ let html=''; const key=c.key; if(key==='path') html=`<div class="cell">${entry.path||entry.latest_path||''}</div>`; else if(key==='file_type') html=`<div class="cell">${entry.file_type||''}</div>`; else if(key==='change_types'){ const types=entry.change_types||[]; html=`<div class="cell">${types.map(pill).join('')}</div>`; } else if(key==='size') html=`<div class="cell">${entry.size??''}</div>`; else if(key==='physical_size') html=`<div class="cell">${entry.physical_size??''}</div>`; else if(key==='ctime') html=`<div class="cell">${fmtDate(entry?.ctime?.sec ?? entry.last_ctime ?? entry.first_ctime)}</div>`; else if(key==='mtime') html=`<div class="cell">${fmtDate(entry?.mtime?.sec)}</div>`; else if(key==='path_delta') html=`<div class="cell">${pathDelta(entry)}</div>`; else if(key==='timeline'){ if(entry.__group){ const times=entry.events.map(ev=>ev?.ctime?.sec).filter(s=>typeof s==='number'); html=`<div class="cell">${sparkline(times)}</div>`; } else { html=`<div class="cell"></div>`; } } else if(key==='lin') html=`<div class="cell">${entry.lin??''}</div>`; else if(key==='uid') html=`<div class="cell">${entry.uid??''}</div>`; else if(key==='gid') html=`<div class="cell">${entry.gid??''}</div>`; else if(key==='parent_lin') html=`<div class="cell">${entry.parent_lin??''}</div>`; else if(key==='id') html=`<div class="cell">${entry.id??''}</div>`; else if(key==='user_flags') html=`<div class="cell">${Array.isArray(entry.user_flags)? entry.user_flags.join(', '):''}</div>`; else if(key==='data_pool') html=`<div class="cell">${entry.data_pool??''}</div>`; else if(key==='metadata_pool') html=`<div class="cell">${entry.metadata_pool??''}</div>`; else if(key==='atime') html=`<div class="cell">${fmtDate(entry?.atime?.sec)}</div>`; else if(key==='btime') html=`<div class="cell">${fmtDate(entry?.btime?.sec)}</div>`; cells.push(html); } return cells.join(''); }

  function showDetails(entry){ 
    el.detailsSummary.textContent=`${entry.path||entry.latest_path||''} · ${entry.file_type||''}`; 
    el.detailsJson.textContent=JSON.stringify(entry,null,2); 
  }
  function showGroupEvents(group){ 
    const evs=group.events||[]; 
    const lines=evs.map(ev=> `${fmtDate(ev?.ctime?.sec)}  ${ev.file_type||''}  ${(ev.change_types||[]).join('|')}  ${ev.path||''}`).join('\n'); 
    el.detailsSummary.textContent=`Group LIN ${group.lin} · ${evs.length} event(s)`; 
    el.detailsJson.textContent=lines; 
  }
  function renderTimelineCards(){
    el.timeline.innerHTML=''; 
    if(!groupByLin){ 
      el.timeline.innerHTML='<div class="muted">Timeline shows when grouped by LIN.</div>'; 
      return; 
    } 
    const frag=document.createDocumentFragment(); 
    const data=grouped.slice(0,20); 
    data.forEach(g=>{ const card=document.createElement('div'); 
    card.className='row'; card.style.gap='8px'; 
    card.innerHTML=`<div class="muted">LIN ${g.lin||''}</div>${sparkline(g.events.map(ev=>ev?.ctime?.sec).filter(Boolean))}<div class="muted">${fmtDate(g.first_ctime)} → ${fmtDate(g.last_ctime)}</div>`; 
    card.addEventListener('click',()=> showGroupEvents(g)); 
    frag.appendChild(card); }); 
    el.timeline.appendChild(frag); 
  }

  function buildDirSet(list){
    const set=new Set(['/']); 
    for(const e of list){ 
      const p=e.path||e.latest_path||'';
      const parts=p.split('/').filter(Boolean); 
      let acc=''; 
      for(let i=0;i<parts.length;i++){ 
        acc+='/'+parts[i]; 
        set.add(acc); 
      } 
    } 
    return set; 
  }
  function treeFromSet(set){ 
    const root={path:'/',name:'/',children:[]}; 
    const nodes={'/':root}; 
    const sorted=Array.from(set).sort(); 
    for(const p of sorted){ 
      if(p==='/') continue; nodes[p]={path:p,name:p.split('/').filter(Boolean).slice(-1)[0],children:[]}; 
    } 
    for(const p of sorted){ 
      if(p==='/') continue; 
      const parent='/' + p.split('/').filter(Boolean).slice(0,-1).join('/'); 
      (nodes[parent]||root).children.push(nodes[p]); 
    } 
    return root; 
  }
  
  function renderTree(){ const list = filtered; const set = buildDirSet(list); const tree = treeFromSet(set); el.treeRoot.innerHTML=''; const ul = document.createElement('ul');
    function make(node){ const li=document.createElement('li'); const head=document.createElement('div'); head.className='node'; if(node.path===selectedDir) head.classList.add('active'); const tog=document.createElement('span');
      tog.className='toggle'; const hasChildren = node.children && node.children.length; tog.textContent = hasChildren ? (expansion.get(node.path)?'▾':'▸') : '';
      const label=document.createElement('span'); label.className='label'; label.textContent = node.name; const cnt=document.createElement('span'); cnt.className='count'; const c = filtered.filter(e=> (e.path||'').startsWith(node.path)).length; cnt.textContent = `(${c})`;
      head.appendChild(tog); head.appendChild(label); head.appendChild(cnt);
      head.addEventListener('click', ()=>{ selectedDir = node.path; applyFilters(); });
      tog.addEventListener('click', (ev)=>{ ev.stopPropagation(); expansion.set(node.path, !expansion.get(node.path)); renderTree(); });
      li.appendChild(head);
      if(hasChildren){ const wrap=document.createElement('div'); wrap.className='children'; wrap.style.display = expansion.get(node.path)?'':'none'; node.children.forEach(ch=> wrap.appendChild(make(ch))); li.appendChild(wrap); }
      return li;
    }
    ul.appendChild(make(tree)); el.treeRoot.appendChild(ul);
  }

  function renderColumnSelector(){ 
    el.columnsList.innerHTML=''; 
    const frag=document.createDocumentFragment(); 
    columns.forEach(c=>{ const row=document.createElement('label'); 
    row.className='opt'; 
    const input=document.createElement('input'); 
    input.type='checkbox'; 
    input.checked=!!c.visible; input.dataset.key=c.key; 
    input.name='col'; 
    const text=document.createElement('span'); 
    text.textContent=c.label; row.appendChild(input); 
    row.appendChild(text); 
    input.addEventListener('change',()=>{ c.visible=input.checked; renderHeader(); renderVirtualRows();  }); 
    frag.appendChild(row); }); 
    el.columnsList.appendChild(frag); 
  }

  function applyPreset(name){ 
    const minimal=new Set(['path','file_type','change_types','ctime','path_delta','lin']); 
    const extended=new Set(['path','file_type','change_types','size','physical_size','ctime','mtime','path_delta','timeline','lin']); 
    const all=new Set(columns.map(c=>c.key)); 
    const pick=name==='Minimal'? minimal : name==='Extended'? extended : all; columns.forEach(c=> c.visible=pick.has(c.key)); 
    renderColumnSelector(); renderHeader(); renderVirtualRows();  
  }

  function readJsonFileFromInput(event) {
    el.messageDisplay.textContent = ""; // Clear previous messages

    const file = event.target.files[0];
    if (!file) {
      showMessage("No file selected. Please choose a file.", "error");
      return;
    }

    if (!file.type === "application/json") {
      showMessage("Unsupported file type. Please select a text file.", "error");
      return;
    }
    const reader = new FileReader();
    reader.onload = function(e){
      try {
      const data = JSON.parse(e.target.result);
      if (!data || !data.entries) {
        console.error("Invalid JSON file. Not a changelist JSON file.");
        showMessage("Not a valid ChangeList JSON file. Please check the file format.", "error");
        return;
      }
      allEntries = data.entries.slice();
      selectedDir = '/';
      groupByLin = false;
      el.groupByLin.checked = false;
      el.fPath.value = '';
      applyFilters();
      } catch (err) {
        console.error("Error parsing the JSON file:", err);
        showMessage("Error reading the file. Please check the file format.", "error");
        return;
      }
    }
    reader.onerror = () => {
      console.error("Error reading the file. Please try again.");
      showMessage("Error reading the file. Please try again.", "error");
    }
    reader.readAsText(file);
    DemoMode = false;
    showMessage("[ " + file.name + " ]", "success");
  }
  
  // Events

  // Side panel Events
  el.treeSearch.addEventListener('input', () => {
    const query = el.treeSearch.value.trim().toLowerCase();
    Array.from(el.treeRoot.querySelectorAll('.node .label')).forEach(labelElement => {
      const show = labelElement.textContent.toLowerCase().includes(query);
      labelElement.parentElement.style.display = show ? '' : 'none';
    });
  });

  el.expandAll.addEventListener('click', () => {
    const set = buildDirSet(filtered);
    set.forEach(path => expansion.set(path, true));
    renderTree();
  });
  el.collapseAll.addEventListener('click', ()=>{ 
    expansion = new Map(); 
    renderTree(); 
  });

  // global Events
  el.themeToggle.addEventListener('click',()=> document.body.classList.toggle('theme-light'));
  el.resetBtn.addEventListener('click', () => resetAll(resetDemo=false));
  el.reloadDemoBtn.addEventListener('click', () => resetAll(resetDemo=true));

  function resetAll(resetDemo = false) {
    if (resetDemo) { DemoMode = true; }
    if (DemoMode) {
      allEntries = sampleChangeList.entries.slice();
      showMessage("[ Demo Mode ]", "success");
    }
    selectedDir = '/';
    groupByLin = false;
    el.groupByLin.checked = false;
    el.fPath.value = '';
    el.fName.value = '';
    el.fType.value = '';
    el.fStart.value = '';
    el.fEnd.value = '';
    el.sortField.value = 'ctime.sec';
    el.sortDir.value = 'desc';
    sortField = 'ctime.sec';
    sortDir = 'desc';
    rowHeight = 36;
    el.rowHeight.value = 36;
    el.viewport.scrollTop = 0;
    el.detailsSummary.textContent = 'Select a row to view details';
    el.detailsJson.textContent = '';
    el.treeSearch.value = '';
    el.importJson.value = '';
    resetChangeTypesMenu();
    applyPreset('Minimal');
    applyFilters();
    renderTree();
  }

  el.importJson.addEventListener('change', readJsonFileFromInput);

  // Filter Events
  el.fPath.addEventListener('input',applyFilters); 
  el.fName.addEventListener('input',applyFilters); 
  el.fType.addEventListener('change',applyFilters); 
  el.fStart.addEventListener('change',applyFilters); 
  el.fEnd.addEventListener('change',applyFilters);
  el.groupByLin.addEventListener('change',()=>{ 
    groupByLin=el.groupByLin.checked; 
    applyFilters(); 
  });

  el.sortField.addEventListener('change', ()=>{ sortField = el.sortField.value; applyFilters(); });
  el.sortDir.addEventListener('change', ()=>{ sortDir = el.sortDir.value; applyFilters(); });
  el.rowHeight.addEventListener('input', ()=>{ rowHeight = Number(el.rowHeight.value)||36; renderVirtualRows(); });

  el.columnsBtn.addEventListener('click',()=> el.columnsMenu.classList.toggle('show'));
  el.presetMin.addEventListener('click',()=> applyPreset('Minimal')); 
  el.presetExt.addEventListener('click',()=> applyPreset('Extended')); 
  el.presetAll.addEventListener('click',()=> applyPreset('All'));
  el.viewport.addEventListener('scroll',renderVirtualRows);

  // Change Type Dropdown menu behavior
  // Toggle Change Types Menu
  el.changeTypesBtn.addEventListener('click', toggleChangeTypesMenu);

  // Hide menus when clicking outside
  document.addEventListener('click', hideMenusOutsideClick);

  // Apply filters when changing types
  Array.from(el.changeTypesMenu.querySelectorAll('input')).forEach(chk => chk.addEventListener('change', applyFilters));

  // Toggle Change Types Menu
  function toggleChangeTypesMenu() {
    el.changeTypesMenu.classList.toggle('show');
  }

  // Hide menus when clicking outside
  function hideMenusOutsideClick(ev) {
    if (!el.changeTypesBtn.contains(ev.target) && !el.changeTypesMenu.contains(ev.target)) {
      el.changeTypesMenu.classList.remove('show');
    }
    if (!el.columnsBtn.contains(ev.target) && !el.columnsMenu.contains(ev.target)) {
      el.columnsMenu.classList.remove('show');
    }
  }
  // reset ChangeType Filters
  el.resetTypesMenu.addEventListener('click',()=>{
    resetChangeTypesMenu();
    applyFilters();
  });

  function resetChangeTypesMenu() {
    Array.from(el.changeTypesMenu.querySelectorAll('input')).forEach(chk => chk.checked = false);
  }

  // Make splitters for adjustable layout
  function makeSplitter(splitter, leftIdx, rightIdx) {
    let startX = 0;
    let cols = getComputedStyle(el.shell).gridTemplateColumns.split(' ');

    // Event handler for mousedown on splitter
    splitter.addEventListener('mousedown', (ev) => {
      startX = ev.clientX;
      const startCols = cols.map(c => parseFloat(c));

      // Event handler for mousemove
      const mm = (e) => {
        const dx = e.clientX - startX;
        let L = startCols[leftIdx] + dx;
        let R = startCols[rightIdx] - dx;
        L = Math.max(160, L);
        R = Math.max(260, R);
        cols[leftIdx] = L + 'px';
        cols[rightIdx] = R + 'px';
        el.shell.style.gridTemplateColumns = cols.join(' ');
      };

      // Event handler for mouseup
      const mu = () => {
        document.removeEventListener('mousemove', mm);
        document.removeEventListener('mouseup', mu);
      };

      // Add event listeners
      document.addEventListener('mousemove', mm);
      document.addEventListener('mouseup', mu);
    });
  }
  makeSplitter(el.splitLeft,0,2); makeSplitter(el.splitRight,2,4);

  // Export
  function rowsForExport(){ return rowsData().filter(e=> !e.__group); }
  // Export JSON
  el.exportJson.addEventListener('click', exportJson);
  function exportJson() {
    const data = rowsData();
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'changelist_filtered.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  // Export CSV
  el.exportCsv.addEventListener('click', exportCsv);

  function exportCsv() {
    const data = rowsForExport();
    // todo: change to only include selected columns
    const header = ['path', 'file_type', 'change_types', 'size', 'physical_size', 'ctime', 'mtime', 'lin', 'id', 'parent_lin'];
    const lines = [header.join(',')];
    data.forEach(e => {
      const row = [
        (e.path || '').replaceAll('"', '\"'),
        (e.file_type || '').replaceAll('"', '\"'),
        (Array.isArray(e.change_types) ? e.change_types.join('|') : ''),
        e.size ?? '',
        e.physical_size ?? '',
        e?.ctime?.sec ?? '',
        e?.mtime?.sec ?? '',
        e.lin ?? '',
        (e.id || '').replaceAll('"', '\"'),
        e.parent_lin ?? ''
      ];
      lines.push(row.map(v => typeof v === 'string' && v.includes(',') ? '"' + v + '"' : v).join(','));
    });
    const blob = new Blob([lines.join('\n')], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'changelist_filtered.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  // Details copy
  // Copy details to clipboard
  el.copyJson.addEventListener('click', async () => {
    const text = el.detailsJson.textContent;
    if (!text) return;

    try {
      await navigator.clipboard.writeText(text);
      alert('Copied');
    } catch (e) {
      alert(`Copy failed: ${e.message}`);
    }
  });

  // Init the viewer
  function init(){ 
    if (DemoMode) { showMessage("[ Demo Mode ]", "success"); }
    applyPreset("Minimal"); 
    applyFilters(); 
  };
  init();

</script>
</body>
</html>
